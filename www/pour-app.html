<!--
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="components/topeka-elements/topeka-categories.html">
<link rel="import" href="components/topeka-elements/topeka-category.html">
<link rel="import" href="components/topeka-elements/topeka-leaderboard.html">
<link rel="import" href="components/topeka-elements/topeka-profile.html">
<link rel="import" href="components/core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="components/core-animated-pages/transitions/slide-up.html">
<link rel="import" href="components/core-animated-pages/transitions/scale-up.html">
<link rel="import" href="components/core-animated-pages/transitions/tile-cascade.html">
<link rel="import" href="components/core-media-query/core-media-query.html">
<link rel="import" href="pour-actions.html">
<link rel="import" href="pour-weigh.html">

<polymer-element name="pour-app" attributes="selected manager drippers beans scale" vertical layout>
    <template>

        <link rel="stylesheet" href="pour-app.css">

        <core-animated-pages selected="{{selected}}" transitions="cross-fade cross-fade-delayed scale-up slide-up slide-up-offscreen slide-down tile-cascade hero-transition" flex auto on-core-animated-pages-transition-end="{{transitionEndAction}}">

            <div name="splash">
                <span fit class="splash {{ {wide: wide} | tokenList }}" cross-fade></span>
            </div>

            <pour-actions id="actions" name="actions" drippers="{{drippers}}" beans="{{beans}}"
			  manager="{{manager}}" selection="{{selection}}" wide="{{wide}}" scale="{{scale}}"
			  rwidth="{{responsiveWidth}}" on-core-activate="{{dripperSelect}}"></pour-actions>

	    <pour-weigh id="weigh" name="weigh" scale="{{scale}}" wide="{{wide}}"></topeka-category>
      


        </core-animated-pages>

        <core-media-query query="min-width: {{responsiveWidth}}" queryMatches="{{wide}}"></core-media-query>

    </template>
    <script>

    (function() {

        window.setPourTransitionSpeed = function(ms) {
            CoreStyle.g.transitions.duration = ms + 'ms';
            CoreStyle.g.transitions.scaleDelay = CoreStyle.g.transitions.duration;
        }

        setPourTransitionSpeed(350);

        Polymer('pour-app', {

            selected: 'splash',

            responsiveWidth: '900px',

            minSplashTime: 1000,

            observe: {
                'manager scales': 'scalesChanged',
            },

            ready: function() {
		console.log('manager2: ' + this.manager);
                this.readyTime = Date.now();

                var dummyState = {app: 'pour'};
                // set up history state
                if (!history.state) {
                    history.pushState(dummyState, '');
                }

                // "back" button will show categories, unless in profile screen
                window.onpopstate = function() {
                    if (this.selected !== 'profile') {
                        this.showCategories();
                    }
                    // repopulate history state so we get the popstate event again
                    history.pushState(dummyState, '');
                }.bind(this);

		this.startup();
            },

            scalesChanged: function() {
                console.log('scales changed');
            },

	    dripperSelect: function() {
		console.log('dripperSelect: ' + (this.selection && this.selection.name));
		if (this.selection) {
		    var n = this.selection.name;
		    if (n === 'weigh') {
			this.showWeigh();
		    } else if (n === 'profile') {
			this.showProfile();
		    } else {
			this.showCategory();
		    }
		}
	    },

            eventDelegates: {
                'main': 'showActions',
            },

            showActions: function() {
		console.log('show-actions');
                this.selected = 'actions';
            },

            showCategories: function() {
                this.selected = 'categories';
            },

            showCategory: function() {
                this.selected = 'category';
            },

            showLeaderboard: function() {
                this.selected = 'leaderboard';
            },

            showWeigh: function() {
                this.selected = 'weigh';
            },

            showProfile: function() {
                this.selected = 'profile';
            },

            startup: function() {
                var elapsed = Date.now() - this.readyTime;
                var t = this.minSplashTime - elapsed;
                this.async('completeStartup', null, t > 0 ? t : 0);
            },

            completeStartup: function() {
		this.selected = 'actions';
            },

            transitionEndAction: function() {
            }
        });
    })();
    </script>
</polymer-element>
