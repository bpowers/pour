<!--
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="components/topeka-elements/topeka-categories.html">
<link rel="import" href="components/topeka-elements/topeka-category.html">
<link rel="import" href="components/topeka-elements/topeka-leaderboard.html">
<link rel="import" href="components/topeka-elements/topeka-profile.html">
<link rel="import" href="components/core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="components/core-animated-pages/transitions/slide-up.html">
<link rel="import" href="components/core-animated-pages/transitions/scale-up.html">
<link rel="import" href="components/core-animated-pages/transitions/tile-cascade.html">
<link rel="import" href="components/core-media-query/core-media-query.html">

<polymer-element name="pour-app" attributes="selected manager drippers beans" vertical layout>
    <template>

        <link rel="stylesheet" href="pour-app.css">

        <core-animated-pages selected="{{selected}}" transitions="cross-fade cross-fade-delayed scale-up slide-up slide-up-offscreen slide-down tile-cascade hero-transition" flex auto on-core-animated-pages-transition-end="{{transitionEndAction}}">

            <div name="splash">
                <span fit class="splash {{ {wide: wide} | tokenList }}" cross-fade></span>
            </div>

        </core-animated-pages>

        <core-media-query query="min-width: {{responsiveWidth}}" queryMatches="{{wide}}"></core-media-query>

    </template>
    <script>

    (function() {

        window.setTopekaTransitionSpeed = function(ms) {
            CoreStyle.g.transitions.duration = ms + 'ms';
            CoreStyle.g.transitions.scaleDelay = CoreStyle.g.transitions.duration;
        }

        setTopekaTransitionSpeed(350);

        Polymer('pour-app', {

            selected: 'splash',

            responsiveWidth: '900px',

            minSplashTime: 1000,

            observe: {
            },

            ready: function() {
                this.readyTime = Date.now();

                var dummyState = {app: 'pour'};
                // set up history state
                if (!history.state) {
                    history.pushState(dummyState, '');
                }

                // "back" button will show categories, unless in profile screen
                window.onpopstate = function() {
                    if (this.selected !== 'profile') {
                        this.showCategories();
                    }
                    // repopulate history state so we get the popstate event again
                    history.pushState(dummyState, '');
                }.bind(this);
            },

            eventDelegates: {
                'main': 'showCategories',
            },

            showCategories: function() {
                this.selected = 'categories';
            },

            showCategory: function() {
                this.selected = 'category';
            },

            showLeaderboard: function() {
                this.selected = 'leaderboard';
            },

            showProfile: function() {
                this.selected = 'profile';
            },

            startup: function() {
                var elapsed = Date.now() - this.readyTime;
                var t = this.minSplashTime - elapsed;
                this.async('completeStartup', null, t > 0 ? t : 0);
            },

            completeStartup: function() {
                if (this.user) {
                    this.loadScores();
                    this.selected = 'categories';
                } else {
                    this.resetScores();
                    this.selected = 'profile';
                }
            },

            transitionEndAction: function() {
            }
        });
    })();
    </script>
</polymer-element>
