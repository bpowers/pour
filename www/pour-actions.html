<!--
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="components/topeka-elements/avatars.html">
<link rel="import" href="components/topeka-elements/category-images.html">
<link rel="import" href="components/topeka-elements/category-icons.html">
<link rel="import" href="components/core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="components/core-toolbar/core-toolbar.html">
<link rel="import" href="components/core-selector/core-selector.html">
<link rel="import" href="components/core-icons/device-icons.html">
<link rel="import" href="components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="components/paper-spinner/paper-spinner.html">

<polymer-element name="pour-actions" attributes="rwidth manager scale drippers beans selection wide" vertical layout>
    <template>

        <link rel="stylesheet" href="pour-actions.css">
        <link rel="stylesheet" href="pour-category-themes.css">

        <div class="categories-panel" flex auto>

            <core-toolbar class="category-toolbar" slide-down?="{{parentElement.selected !== 'category' && parentElement.lastSelected !== 'category'}}">
                <paper-icon-button icon="menu" on-tap="{{menuToggle}}" hidden?="{{wide}}"></paper-icon-button>
                <div flex class="scale-name">{{scale.name || '(not connected)'}}</div>
                <core-icon id="statusIcon" icon="device:bluetooth-disabled" title="clear" role="img"></core-button>
                    <paper-spinner class="brown" hidden></paper-spinner>
            </core-toolbar>

            <core-drawer-panel id="panel">
                <div drawer>
                    <div class="drawer-contents" flex>
                        <div center horizontal layout>
                            <div flex>Scan for scales</div>
                            <paper-toggle-button id="discoveryToggle" on-change="{{toggleDiscovery}}"></paper-toggle-button>
                        </div>
                        <br>
                        <div center horizontal layout>
                            Available devices:
                        </div>
                        <core-selector selectedAttribute="" on-core-activate="{{selectScale}}">
                            <template repeat="{{scale, i in manager.scales}}">
                                <paper-item>{{scale.name}}</paper-item>
                            </template>
                        </core-selector>
                    </div>
                </div>

                <div main>
                    <core-selector class="category-list content {{ {wide: wide} | tokenList }}"
                                   selected="{{selected}}"
                                   tile-cascade?="{{parentElement.selected !== 'category' && parentElement.lastSelected !== 'category'}}"
                                   fade?="{{parentElement.lastSelected === 'splash'}}">

                        <template repeat="{{cat, i in categories}}">

                            <template bind="{{allScores[cat.name] as scores}}">
                                <div class="category-item {{cat.theme}}-theme {{ {completed: scores.length == cat.quizzes.length} | tokenList }}" vertical layout needZ?="{{category.name === cat.name}}">
                                    <div class="tile theme-bg-a" dummy fit hero-id="{{category.name === cat.name ? 'punch' : ''}}" hero?="{{category.name === cat.name}}"></div>
                                    <div class="tile" flex auto vertical layout>
                                        <div flex auto relative>
                                            <!-- sizing wrapper -->
                                            <div fit layout vertical center center-justified>
                                                <div class="category-bg-wrapper" relative>
                                                    <core-icon class="category-tile-bg {{ {'theme-icon': scores.length === cat.quizzes.length} | tokenList }}" icon="{{scores.length === cat.quizzes.length ? 'check' : 'category-icons:' + cat.id}}" cross-fade-delayed?="{{category.name === cat.name && parentElement.lastSelected === 'category'}}" fit></core-icon>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="cat-name theme-bg" horizontal center layout hero-id="{{category.name === cat.name ? 'punch-bottom' : ''}}" hero?="{{category.name === cat.name}}">
                                            <div flex>
                                                <span cross-fade-delayed?="{{category.name === cat.name && parentElement.lastSelected === 'category'}}">{{cat.name}}</span>
                                            </div>
                                            <core-icon class="category-icon theme-bg" icon="av:play-arrow" hidden?="{{scores.length === cat.quizzes.length}}" cross-fade-delayed?="{{category.name === cat.name && parentElement.lastSelected === 'category'}}"></core-icon>
                                        </div>
                                    </div>
                                </div>
                            </template>

                        </template>

                        <template repeat="{{scale, i in (scale ? [scale] : [])}}">

                            <div class="category-item profile" vertical layout>
				<div class="tile theme-bg-a" dummy fit></div>
				<div class="tile" flex auto vertical layout>
                                    <div flex auto relative>
					<!-- sizing wrapper -->
					<div fit layout vertical center center-justified>
                                            <div class="category-bg-wrapper" relative>
						<core-icon icon="image:tune" class="category-tile-bg weigh-icon" fit></core-icon>
                                            </div>
					</div>
                                    </div>
                                    <div class="cat-name" horizontal center layout>
					<div flex>Weigh</div>
					<core-icon class="category-icon" icon="arrow-forward"></core-icon>
                                    </div>
				</div>
                            </div>
			</template>

                    </core-selector>
                </div>
            </core-drawer-panel>

        </div>

    </template>
    <script>

    Polymer('pour-actions', {

        observe: {
            'manager.scales': 'scalesChanged',
            'scale.connected': 'connectedChanged',
        },

        wide: false,

        created: function() {
            this.categories = [];
        },

        ready: function() {
            console.log('manager3: ' + this.manager);
            this.$.panel.responsiveWidth = this.rwidth;
        },

        selectedChanged: function() {
	    console.log('selection changed: ' + this.selected);
            // first one is leaderboard, last one is profile
            if (this.selected === 0) {
                this.selection = {name: 'weigh'};
            } else {
                this.selection = this.categories[this.selected - 1];
            }
        },

        selectScale: function(event, target) {
            var off = target.item.getAttribute('tabindex');
            console.log(off);
            this.scale = this.manager.scales[off];
	    console.log('connecting');
	    this.scale.connect();
        },

        menuToggle: function() {
            this.$.panel.togglePanel();
        },

        scalesChanged: function() {
            console.log('scales changed');
        },

        connectedChanged: function() {
	    console.log('connected change: ' + this.scale.connected);
            if (this.scale.connected)
                this.$.statusIcon.setAttribute('icon', 'device:bluetooth-connected');
        },

        toggleDiscovery: function(event, detail, target) {
            var checked = target.getAttribute('aria-pressed') === 'false';
            if (checked) {
                this.$.statusIcon.setAttribute('icon', 'device:bluetooth-searching');
                this.manager.startDiscovery();
            } else {
                if (!this.scale)
                    this.$.statusIcon.setAttribute('icon', 'device:bluetooth-disabled');
                this.manager.stopDiscovery();
            }
            console.log('toggle discovery: ' + checked);
        },
    });

    </script>
</polymer-element>
